{% extends "layout/layout_write.html" %}
{% load widget_tweaks static %}

{% block title %}
    Edit Profile
{% endblock %}

{% block extra_head %}
    <style>
        .avatar-preview {
            width: 128px;
            height: 128px;
            object-fit: cover;
            border-radius: .25rem;
            border: 1px solid #dee2e6;
        }

        .cropper-container {
            border: 2px dashed #dee2e6;
            border-radius: .5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .cropper-container.active {
            border-color: #0d6efd;
            background-color: #fff;
        }

        .crop-area {
            height: 300px;
            width: 100%;
            border-radius: .25rem;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .crop-placeholder {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .crop-controls {
            margin-top: 1rem;
            display: none;
        }

        .crop-controls.show {
            display: block;
        }

        .avatar-section {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .preview-section {
            flex-shrink: 0;
        }

        .cropper-section {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 768px) {
            .avatar-section {
                flex-direction: column;
                gap: 1rem;
            }

            .preview-section {
                align-self: center;
            }
        }
    </style>
{% endblock %}

{% block cdn %}
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
        rel="stylesheet"
    >
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
    ></script>
{% endblock %}

{% block content %}
    <div
        class="container mt-5 d-flex justify-content-center align-items-center"
        style="min-height: 80vh;"
    >
        <div
            class="card p-4 shadow-sm"
            style="max-width: 800px; width: 100%;"
        >
            <h3 class="text-center mb-4 fw-semibold">
                Edit Profile
            </h3>

            <form
                id="profileForm"
                method="post"
                enctype="multipart/form-data"
                novalidate
            >
                {% csrf_token %}

                <!-- Avatar Section -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        Profile Picture
                    </label>

                    <div class="avatar-section">
                        <!-- Preview Section -->
                        <div class="preview-section text-center">
                            <img
                                id="avatarPreview"
                                class="avatar-preview mb-2"
                                src="{% if profile.user_profile_img %}data:image/png;base64,{{ profile.user_profile_img }}{% else %}{% static 'images/avatar_placeholder.png' %}{% endif %}"
                                alt="avatar preview"
                            />
                            <div class="small text-muted">
                                Preview
                            </div>
                        </div>

                        <!-- Cropper Section -->
                        <div class="cropper-section">
                            <div
                                class="cropper-container"
                                id="cropperContainer"
                            >
                                <div
                                    class="crop-area"
                                    id="cropArea"
                                >
                                    <div class="crop-placeholder">
                                        <i
                                            class="fas fa-cloud-upload-alt mb-2 d-block"
                                            style="font-size: 2rem;"
                                        ></i>
                                        Click "Select Image" to upload and crop your avatar
                                    </div>
                                    <img
                                        id="cropperImage"
                                        style="display: none;"
                                        alt=""
                                    />
                                </div>

                                <div
                                    class="crop-controls"
                                    id="cropControls"
                                >
                                    <div class="d-flex gap-2 justify-content-between align-items-center">
                                        <small class="text-muted">
                                            Drag to reposition • Scroll to zoom
                                        </small>
                                        <div class="d-flex gap-2">
                                            <button
                                                type="button"
                                                class="btn btn-outline-secondary btn-sm"
                                                id="resetCropBtn"
                                            >
                                                <i class="fas fa-undo"></i>
                                                Reset
                                            </button>
                                            <button
                                                type="button"
                                                class="btn btn-primary btn-sm"
                                                id="applyCropBtn"
                                            >
                                                <i class="fas fa-check"></i>
                                                Apply
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2">
                                {{ form.user_profile_img|add_class:"d-none" }}
                                {{ form.user_profile_img_base64 }}

                                <button
                                    id="selectImageBtn"
                                    type="button"
                                    class="btn btn-outline-primary"
                                >
                                    <i class="fas fa-image"></i>
                                    Select Image
                                </button>
                                <button
                                    id="removeImageBtn"
                                    type="button"
                                    class="btn btn-outline-danger ms-2"
                                    style="display: none;"
                                >
                                    <i class="fas fa-trash"></i>
                                    Remove
                                </button>
                            </div>

                            {% if form.user_profile_img.errors %}
                                <div class="invalid-feedback d-block text-start mt-1">
                                    {{ form.user_profile_img.errors|striptags }}
                                </div>
                            {% endif %}
                            <small class="text-muted d-block mt-1">
                                JPEG/PNG • Max 2 MB • Will be resized to 128×128px
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Name Field -->
                <div class="mb-3">
                    {{ form.name.label_tag }}
                    {{ form.name|add_class:"form-control" }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.name.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Student ID Field -->
                <div class="mb-3">
                    {{ form.information_id.label_tag }}
                    {{ form.information_id|add_class:"form-control" }}
                    {% if form.information_id.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.information_id.errors }}
                        </div>
                    {% endif %}
                </div>

                {% if form.non_field_errors %}
                    <div class="invalid-feedback d-block mb-3">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <button
                    class="btn btn-primary w-100 py-2"
                    type="submit"
                >
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </form>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        (() => {
            /* DOM References */
            const fileInput         = document.querySelector('input[name="user_profile_img"]');
            const base64Input       = document.querySelector('input[name="user_profile_img_base64"]');
            const selectBtn         = document.getElementById('selectImageBtn');
            const removeBtn         = document.getElementById('removeImageBtn');
            const previewImg        = document.getElementById('avatarPreview');
            const cropImg           = document.getElementById('cropperImage');
            const cropArea          = document.getElementById('cropArea');
            const cropControls      = document.getElementById('cropControls');
            const cropperContainer  = document.getElementById('cropperContainer');
            const resetCropBtn      = document.getElementById('resetCropBtn');
            const applyCropBtn      = document.getElementById('applyCropBtn');

            let cropper = null;
            let originalImageSrc = null;

            /* Update button visibility based on editing state */
            function updateButtons(editing) {
                if (editing) {
                    selectBtn.style.display = 'none';
                    cropControls.classList.add('show');
                } else {
                    selectBtn.style.display = 'inline-block';
                    cropControls.classList.remove('show');
                }
            }

            /* Restore state after load */
            document.addEventListener('DOMContentLoaded', () => {
                const hasImage = Boolean(base64Input.value);
                if (hasImage) {
                    previewImg.src = 'data:image/png;base64,' + base64Input.value;
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
                updateButtons(false);
            });

            /* File selection */
            selectBtn.addEventListener('click', () => fileInput.click());

            /* File input change handler */
            fileInput.addEventListener('change', e => {
                if (!e.target.files.length) return;
                const file = e.target.files[0];

                if (!/^image\/(jpe?g|png)$/i.test(file.type)) {
                    alert('Only JPG and PNG images are supported.');
                    fileInput.value = '';
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    alert('File size must be less than 2MB.');
                    fileInput.value = '';
                    return;
                }
                loadImageToCropper(file);
            });

            /* Load image to cropper */
            function loadImageToCropper(file) {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                originalImageSrc = URL.createObjectURL(file);
                cropImg.src = originalImageSrc;
                cropImg.style.display = 'block';
                cropArea.querySelector('.crop-placeholder').style.display = 'none';
                cropperContainer.classList.add('active');
                removeBtn.style.display = 'inline-block';
                updateButtons(true);

                cropper = new Cropper(cropImg, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    checkOrientation: false,
                    modal: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            }

            /* Reset crop */
            resetCropBtn.addEventListener('click', () => {
                if (cropper) cropper.reset();
            });

            /* Apply crop */
            applyCropBtn.addEventListener('click', () => {
                if (!cropper) return;
                const canvas = cropper.getCroppedCanvas({
                    width: 128,
                    height: 128,
                    imageSmoothingQuality: 'high'
                });
                const dataURL = canvas.toDataURL('image/png', 0.9);
                base64Input.value = dataURL.split(',')[1];
                previewImg.src = dataURL;
                fileInput.value = '';

                applyCropBtn.innerHTML = '<i class="fas fa-check"></i> Applied!';
                applyCropBtn.classList.replace('btn-primary', 'btn-success');

                setTimeout(() => {
                    applyCropBtn.innerHTML = '<i class="fas fa-check"></i> Apply';
                    applyCropBtn.classList.replace('btn-success', 'btn-primary');
                }, 1000);

                cropperContainer.classList.remove('active');
                updateButtons(false);
            });

            /* Remove image */
            removeBtn.addEventListener('click', () => {
                base64Input.value = '';
                fileInput.value = '';
                previewImg.src = '{% static "images/avatar_placeholder.png" %}';

                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cropImg.style.display = 'none';
                cropArea.querySelector('.crop-placeholder').style.display = 'block';
                cropperContainer.classList.remove('active');
                updateButtons(false);
                removeBtn.style.display = 'none';

                if (originalImageSrc) {
                    URL.revokeObjectURL(originalImageSrc);
                    originalImageSrc = null;
                }
            });

            /* Cleanup on page unload */
            window.addEventListener('beforeunload', () => {
                if (originalImageSrc) {
                    URL.revokeObjectURL(originalImageSrc);
                }
            });
        })();
    </script>
{% endblock %}
