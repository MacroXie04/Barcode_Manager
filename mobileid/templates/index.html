{% extends 'layout.html' %}
{% load static %}

{% block content %}
    <!-- Centered Profile Section -->
    <div class="text-center" style="margin-top: 2em;">
        <a href="/" id="setting-icon">
            <img src="{% static 'images/profile_img.jpg' %}"
                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4); transition: transform 0.3s ease-in-out;" class="img-circle"
                 alt="User profile picture">
        </a>

        <h4 class="white-h4" style="margin-top: 0.5em; color: white !important;">
            {{ name }} </h4>

        <h4 id="student-id" class="white-h4" style="color: white !important;">
            {{ student_id }} </h4>

        <!-- Pay/Check-in Button -->
        <div id="show-info-button" style="margin-top: 1em;">
            <button type="button" class="btn btn-trans btn-trans-default"><b>PAY / Check-in</b></button>
        </div>

    </div>

    <!-- Display Barcode -->
    <div id="qrcode" class="text-center">
        <div id="qrcode-div" style="display: none;">Barcode</div>
        <br>
        <div id="qrcode-code" style="display: none;">
            <div class="progress" style="width: 70%; display: inline-block;">
                <div class="progress-bar progress-bar-white" role="progressbar" aria-valuenow="100"
                     aria-valuemin="0" aria-valuemax="100" style="width:100%">
                </div>
            </div>
        </div>
    </div>

    <div style="margin: auto; max-width: 320px;">
        <div class="grid-container">
            <!-- First Row -->
            <a href="{% url 'settings' %}" class="btn-grid">
                <i class="fa fa-credit-card fa-2x"></i>
                <p>Add Funds</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-money-bill fa-2x"></i>
                <p>Balance</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-id-card fa-2x"></i>
                <p>Lost My Card</p>
            </a>

            <!-- Second Row -->
            <a href="#" class="btn-grid">
                <i class="fa fa-exclamation-triangle fa-2x"></i>
                <p id="server_status">Emergency</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-dumbbell fa-2x"></i>
                <p>Gym</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-info fa-2x"></i>
                <p>Resources</p>
            </a>

            <!-- Third Row -->
            <a href="{% url 'logout' %}" class="btn-grid">
                <i class="fa fa-sign-out-alt fa-2x"></i>
                <p>Log out</p>
            </a>
        </div>
    </div>

    <!-- Generate Barcode JavaScript -->
    <script src="{% static 'assets/js/bcmath-min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/pdf417-min.js' %}" type="text/javascript"></script>
    <script>
        /* CSRF Token */
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        /* Generate Barcode */
        $('#show-info-button').click(function () {
            $('#server_status').text("Processing");
            $.ajax({
                type: "POST",
                url: "generate_barcode/",
                data: {},
                success: function (response) {
                    // 成功时显示“成功的code+ added”
                    $('#server_status').text(response.code + " added");

                    var studentId = response.student_id;

                    var now = new Date();
                    var year = now.getFullYear();
                    var month = String(now.getMonth() + 1).padStart(2, '0');
                    var day = String(now.getDate()).padStart(2, '0');
                    var hours = String(now.getHours()).padStart(2, '0');
                    var minutes = String(now.getMinutes()).padStart(2, '0');
                    var seconds = String(now.getSeconds()).padStart(2, '0');
                    var formattedTimestamp = year + month + day + hours + minutes + seconds;

                    var magstripWithTimestamp = formattedTimestamp + studentId;

                    // 初始化 PDF417 并生成 barcode
                    PDF417.init(magstripWithTimestamp);
                    var barcode = PDF417.getBarcodeArray();

                    // 设置绘制条码的单元块尺寸
                    var bw = 2.5;
                    var bh = 1;

                    // 在指定容器中创建 canvas 元素
                    var container = document.getElementById('qrcode-div');
                    if (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }
                    var canvas = document.createElement('canvas');
                    canvas.setAttribute("id", "canvas");
                    canvas.width = bw * barcode['num_cols'];
                    canvas.height = bh * barcode['num_rows'];
                    container.appendChild(canvas);

                    var ctx = canvas.getContext('2d');

                    // 绘制条码：遍历每一行和每一列
                    var y = 0;
                    for (var r = 0; r < barcode['num_rows']; r++) {
                        var x = 0;
                        for (var c = 0; c < barcode['num_cols']; c++) {
                            if (barcode['bcode'][r][c] == 1) {
                                ctx.fillStyle = '#000000';
                                ctx.fillRect(x, y, bw, bh);
                            } else {
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(x, y, bw, bh);
                            }
                            x += bw;
                        }
                        y += bh;
                    }

                    // 处理按钮及相关元素的淡入淡出动画
                    var isFaded = $('#show-info-button').css('display') == 'none';
                    if (isFaded) {
                        setTimeout(function () {
                            $('#show-info-button').fadeIn();
                        }, 400);
                        $('#student-id').fadeOut();
                        $('#qrcode-code').fadeOut();
                        $('#qrcode-div').fadeOut();
                    } else {
                        $('#show-info-button').fadeOut();
                        setTimeout(function () {
                            $('#qrcode-div').fadeIn();
                            $('#qrcode-code').fadeIn();
                            $('#student-id').fadeIn();

                            // 立即重置进度条宽度
                            $('.progress-bar').css({
                                "transition": "none",
                                "width": "100%"
                            });
                            // 延时后平滑收缩进度条（10秒内收缩至0%）
                            setTimeout(function () {
                                $('.progress-bar').css({
                                    "transition": "width 10s linear",
                                    "width": "0%"
                                });
                            }, 50);
                        }, 400);
                        // 进度条消失后隐藏二维码，同时恢复 <p id="server_status"> 中的内容为 “Emergency”
                        setTimeout(function () {
                            $('#qrcode-div').fadeOut(400);
                            $('#qrcode-code').fadeOut(400);
                            $('#student-id').fadeOut(400);
                            // 恢复状态文本
                            $('#server_status').text("Emergency");
                            setTimeout(function () {
                                $('#show-info-button').fadeIn();
                            }, 400);
                        }, 10400);
                    }
                },
                error: function (xhr, status, error) {
                    // 请求失败时，将返回的错误信息显示在 <p id="server_status">
                    $('#server_status').text("Error: " + xhr.responseText);
                }
            });
        });

    </script>

{% endblock %}

