{% extends 'layout.html' %}
{% load static %}

{% block content %}
    <!-- Centered Profile Section -->
    <div class="text-center" style="margin-top: 2em;">
        <a href="/" id="setting-icon">
            <img src="{% static 'images/profile_img.jpg' %}"
                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4); transition: transform 0.3s ease-in-out;" class="img-circle"
                 alt="User profile picture">
        </a>

        <h4 class="white-h4" style="margin-top: 0.5em; color: white !important;">
            {{ name }} </h4>

        <h4 id="student-id" class="white-h4" style="color: white !important;">
            {{ student_id }} </h4>

        <!-- Pay/Check-in Button -->
        <div id="show-info-button" style="margin-top: 1em;">
            <button type="button" class="btn btn-trans btn-trans-default"><b>PAY / Check-in</b></button>
        </div>

    </div>

    <!-- Display Barcode -->
    <div id="qrcode" class="text-center">
        <div id="qrcode-div" style="display: none;">Barcode</div>
        <br>
        <div id="qrcode-code" style="display: none;">
            <div class="progress" style="width: 70%; display: inline-block;">
                <div class="progress-bar progress-bar-white" role="progressbar" aria-valuenow="100"
                     aria-valuemin="0" aria-valuemax="100" style="width:100%">
                </div>
            </div>
        </div>
    </div>

    <div style="margin: auto; max-width: 320px;">
        <div class="grid-container">
            <!-- First Row -->
            <a href="{% url 'settings' %}" class="btn-grid">
                <i class="fa fa-credit-card fa-2x"></i>
                <p>Add Funds</p>
            </a>
            <a href="{% url 'transfer_code' %}" class="btn-grid">
                <i class="fa fa-money-bill fa-2x"></i>
                <p>Balance</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-id-card fa-2x"></i>
                <p>Lost My Card</p>
            </a>

            <!-- Second Row -->
            <a href="#" class="btn-grid">
                <i class="fa fa-exclamation-triangle fa-2x"></i>
                <p id="server_status">Emergency</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-dumbbell fa-2x"></i>
                <p>Gym</p>
            </a>
            <a href="#" class="btn-grid">
                <i class="fa fa-info fa-2x"></i>
                <p>Resources</p>
            </a>

            <!-- Third Row -->
            <a href="{% url 'logout' %}" class="btn-grid">
                <i class="fa fa-sign-out-alt fa-2x"></i>
                <p>Log out</p>
            </a>
        </div>
    </div>

    <!-- Generate Barcode JavaScript -->
    <script src="{% static 'assets/js/bcmath-min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/pdf417-min.js' %}" type="text/javascript"></script>
    <script>
        /* CSRF Token */
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        /* Generate Barcode */
        $('#show-info-button').click(function () {
            $('#server_status').text("Processing");
            $('#show-info-button button').prop('disabled', true);
            $.ajax({
                type: "POST",
                url: "generate_barcode/",
                data: {},
                success: function (response) {
                    // if success, update the server status
                    $('#server_status').text(response.code + " added");

                    // use the server response timestamp and student_id to generate the barcode
                    var timestamp = response.timestamp;
                    var studentId = response.student_id;
                    var magstripWithTimestamp = timestamp + studentId;

                    // initialize the PDF417 barcode generator
                    PDF417.init(magstripWithTimestamp);
                    var barcode = PDF417.getBarcodeArray();

                    // set the canvas size
                    var bw = 2.5;
                    var bh = 1;

                    // create a canvas element to draw the barcode
                    var container = document.getElementById('qrcode-div');
                    if (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }
                    var canvas = document.createElement('canvas');
                    canvas.setAttribute("id", "canvas");
                    canvas.width = bw * barcode['num_cols'];
                    canvas.height = bh * barcode['num_rows'];
                    container.appendChild(canvas);

                    var ctx = canvas.getContext('2d');

                    // calculate the width and height of the barcode
                    var y = 0;
                    for (var r = 0; r < barcode['num_rows']; r++) {
                        var x = 0;
                        for (var c = 0; c < barcode['num_cols']; c++) {
                            if (barcode['bcode'][r][c] == 1) {
                                ctx.fillStyle = '#000000';
                                ctx.fillRect(x, y, bw, bh);
                            } else {
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(x, y, bw, bh);
                            }
                            x += bw;
                        }
                        y += bh;
                    }

                    // animate the barcode
                    var isFaded = $('#show-info-button').css('display') == 'none';
                    if (isFaded) {
                        setTimeout(function () {
                            $('#show-info-button').fadeIn();
                        }, 400);
                        $('#student-id').fadeOut();
                        $('#qrcode-code').fadeOut();
                        $('#qrcode-div').fadeOut();
                    } else {
                        $('#show-info-button').fadeOut();
                        setTimeout(function () {
                            $('#qrcode-div').fadeIn();
                            $('#qrcode-code').fadeIn();
                            $('#student-id').fadeIn();

                            // reset the progress bar to 100%
                            $('.progress-bar').css({
                                "transition": "none",
                                "width": "100%"
                            });
                            // reset the progress bar to 0% after a short delay
                            setTimeout(function () {
                                $('.progress-bar').css({
                                    "transition": "width 10s linear",
                                    "width": "0%"
                                });
                            }, 50);
                        }, 400);
                        // reset the process check-in status
                        setTimeout(function () {
                            $('#qrcode-div').fadeOut(400);
                            $('#qrcode-code').fadeOut(400);
                            $('#student-id').fadeOut(400);

                            $('#show-info-button button').prop('disabled', false);
                            // reset the progress bar to 100%
                            $('#server_status').text("Emergency");
                            setTimeout(function () {
                                $('#show-info-button').fadeIn();
                            }, 400);
                        }, 10400);
                    }
                },
                error: function (xhr, status, error) {
                    // if error, update the server status
                    $('#show-info-button button').prop('disabled', false);
                    $('#server_status').text("Error");
                }
            });
        });


    </script>

{% endblock %}

