{% extends 'layout.html' %}
{% load static %}

{% block content %}
    <style>
        #video-container {
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        #video-container.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <div class="container mt-5 d-flex justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="card p-4 shadow-sm" style="max-width: 400px; width: 100%;">
            <h3 class="text-center mb-4">Barcode Settings</h3>
            <form method="post" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.barcode_status.label_tag }}
                    {{ form.barcode_status }}
                </div>
                <div class="mb-3">
                    {{ form.static_barcode.label_tag }}
                    {{ form.static_barcode }}
                    <!-- Single toggle button for scanning and canceling -->
                    <button type="button" id="toggle-scan-btn" class="btn btn-info w-100 py-2 mt-2"
                            onclick="toggleScan()">Scan CatCard
                    </button>
                    <div id="video-container">
                        <video id="video" width="300" height="200"
                               style="border: 1px solid gray; display: block; margin: 0 auto;"></video>
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.server_verification.label_tag }}
                    {{ form.server_verification }}
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2">Submit</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script>
        const codeReader = new ZXing.BrowserMultiFormatReader();
        let isScanning = false;

        function toggleScan() {
            if (!isScanning) {
                startScanning();
            } else {
                stopScanning();
            }
        }

        function startScanning() {
            isScanning = true;
            const btn = document.getElementById('toggle-scan-btn');
            btn.textContent = 'Cancel Scan';
            const container = document.getElementById('video-container');
            container.style.display = 'block';
            setTimeout(() => container.classList.add('show'), 10);

            codeReader.decodeOnceFromVideoDevice(null, 'video')
                .then(result => {
                    console.log(result);
                    document.getElementById("{{ form.static_barcode.id_for_label }}").value = result.text;
                    stopScanning();
                })
                .catch(err => {
                    console.error(err);
                    // Error messages are suppressed as per requirement.
                    stopScanning();
                });
        }

        function stopScanning() {
            isScanning = false;
            const btn = document.getElementById('toggle-scan-btn');
            btn.textContent = 'Scan CatCard';
            const container = document.getElementById('video-container');
            container.classList.remove('show');
            setTimeout(() => {
                container.style.display = 'none';
            }, 500);
            codeReader.reset();
        }
    </script>
{% endblock %}